{% extends "base.html" %}
{% block content %}
  <style>
    .community-feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .community-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .community-tab {
      text-decoration: none;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--text);
      background: #fff;
      font-size: 0.92rem;
    }
    .community-tab.active {
      border-color: var(--accent);
      color: #fff;
      background: var(--accent);
    }
    .community-meta {
      color: var(--muted);
      font-size: 0.84rem;
      margin-bottom: 8px;
    }
    .community-post-card {
      background: #fff;
      border: 1px solid #d7dee7;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(16, 24, 40, 0.04);
      padding: 12px;
    }
    .community-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .community-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e8eef6;
      color: #0f172a;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .community-title {
      margin: 0 0 2px;
      font-size: 1.12rem;
      line-height: 1.25;
    }
    .community-body {
      margin-top: 0;
      margin-bottom: 12px;
      word-break: break-word;
      line-height: 1.5;
      color: #101828;
    }
    .community-body p {
      margin: 0 0 10px;
    }
    .community-body p:last-child {
      margin-bottom: 0;
    }
    .community-body ul {
      margin: 0 0 10px 20px;
      padding: 0;
    }
    .community-body li {
      margin-bottom: 4px;
    }
    .community-actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--line);
    }
    .community-actions form {
      margin: 0;
    }
    .community-actions .link-btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .community-actions .muted-chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.86rem;
      color: var(--muted);
      background: #fff;
    }
    .community-media {
      margin: 4px 0 12px;
      border: 1px solid #d7dee7;
      border-radius: 12px;
      overflow: hidden;
      background: #f7fafc;
      max-width: 100%;
    }
    .community-media img,
    .community-media video {
      display: block;
      width: 100%;
      max-height: 520px;
      object-fit: cover;
      background: #0f172a;
    }
    .community-comment-list {
      border-top: 1px solid var(--line);
      padding-top: 10px;
      margin-top: 2px;
      margin-bottom: 12px;
    }
    .community-comment {
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 8px;
      margin-bottom: 8px;
      background: #fbfdff;
    }
    .community-comment-meta {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .community-comment p {
      margin: 0;
      word-break: break-word;
    }
    .community-comment-form label {
      margin-bottom: 6px;
    }
  </style>

  <div class="card">
    <h1>Community</h1>
    <p class="muted">
      Members-only community for recipes, health tips, workouts, stories, and lifestyle ideas.
      18+ explicit content is blocked.
    </p>
  </div>

  <div class="card">
    <h2>Share A Post</h2>
    <form method="post" action="{{ url_for('main.community_create_post') }}" enctype="multipart/form-data">
      <input type="hidden" name="return_category" value="{{ selected_category }}" />
      <div class="grid">
        <div>
          <label for="category">Category</label>
          <select id="category" name="category" required>
            {% for option in category_options %}
              <option value="{{ option.key }}" {% if option.key == new_post_category %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="title">Title</label>
          <input id="title" name="title" maxlength="180" placeholder="Short headline" required />
        </div>
      </div>
      <div style="margin-top: 10px;">
        <label for="content">Post</label>
        <textarea id="content" name="content" maxlength="4000" placeholder="Share your recipe, routine, or tip..." required></textarea>
      </div>
      <div style="margin-top: 10px;">
        <label for="media">Image Or Video (optional)</label>
        <input
          id="media"
          name="media"
          type="file"
          accept="image/png,image/jpeg,image/webp,image/heic,image/gif,video/mp4,video/webm,video/quicktime"
        />
      </div>
      <div style="margin-top: 10px;">
        <button type="submit">Publish Post</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Browse</h2>
    <div class="community-tabs">
      {% for tab in category_tabs %}
        <a class="community-tab {% if tab.active %}active{% endif %}" href="{{ url_for('main.community_page', category=tab.key) }}">
          {{ tab.label }} ({{ tab.count }})
        </a>
      {% endfor %}
    </div>
  </div>

  {% if posts %}
    <div class="community-feed">
    {% for card in posts %}
      {% set post = card.post %}
      <article id="post-{{ post.id }}" class="community-post-card">
        <div class="community-head">
          <div class="community-avatar">{{ card.author_name[:1] }}</div>
          <div>
            <h3 class="community-title">{{ post.title }}</h3>
            <div class="community-meta">
              {{ card.author_name }} | {{ post.category|capitalize }} | {{ post.created_at.strftime('%b %d, %Y %I:%M %p') }}
            </div>
          </div>
        </div>

        <div class="community-body">{{ card.content_html }}</div>
        {% if post.media_path %}
          <div class="community-media">
            {% if post.media_kind == "video" %}
              <video controls preload="metadata" src="{{ uploaded_file_url(post.media_path) }}"></video>
            {% else %}
              <img src="{{ uploaded_file_url(post.media_path) }}" alt="Community post media" loading="lazy" />
            {% endif %}
          </div>
        {% endif %}

        <div class="community-actions">
          <form method="post" action="{{ url_for('main.community_toggle_like', post_id=post.id) }}">
            <input type="hidden" name="category" value="{{ selected_category }}" />
            <button type="submit">
              {% if card.liked_by_me %}Unlike{% else %}Like{% endif %} ({{ card.like_count }})
            </button>
          </form>

          <span class="muted-chip">{{ card.comment_count }} comment{% if card.comment_count != 1 %}s{% endif %}</span>

          <a class="link-btn" href="{{ card.share.x }}" target="_blank" rel="noopener noreferrer">Share X</a>
          <a class="link-btn" href="{{ card.share.facebook }}" target="_blank" rel="noopener noreferrer">Facebook</a>
          <a class="link-btn" href="{{ card.share.linkedin }}" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          <a class="link-btn" href="{{ card.share.reddit }}" target="_blank" rel="noopener noreferrer">Reddit</a>
          <a class="link-btn" href="{{ card.share.email }}">Email</a>
          <button type="button" class="link-btn copy-link-btn" data-url="{{ card.share.copy_url }}">Copy Link</button>

          <form method="post" action="{{ url_for('main.community_report_post', post_id=post.id) }}">
            <input type="hidden" name="category" value="{{ selected_category }}" />
            <input type="hidden" name="reason" value="User reported post" />
            <button class="link-btn" type="submit">Report</button>
          </form>

          {% if post.user_id == current_user.id %}
            <a class="link-btn" href="{{ url_for('main.community_edit_post_form', post_id=post.id, category=selected_category) }}">Edit</a>
            <form method="post" action="{{ url_for('main.community_delete_post', post_id=post.id) }}">
              <input type="hidden" name="category" value="{{ selected_category }}" />
              <button type="submit" style="background: #b42318;">Delete</button>
            </form>
          {% endif %}
        </div>

        <div class="community-comment-list">
          {% if card.comments %}
            {% for comment in card.comments %}
              {% set comment_name = (comment.user.full_name.split(' ')[0] if comment.user and comment.user.full_name else 'Member') %}
              <div class="community-comment">
                <div class="community-comment-meta">
                  {{ comment_name }} | {{ comment.created_at.strftime('%b %d, %Y %I:%M %p') }}
                </div>
                <p>{{ comment.content | e | replace('\n', '<br />') | safe }}</p>
                <form method="post" action="{{ url_for('main.community_report_comment', comment_id=comment.id) }}" style="margin-top: 6px;">
                  <input type="hidden" name="category" value="{{ selected_category }}" />
                  <input type="hidden" name="reason" value="User reported comment" />
                  <button class="link-btn" type="submit">Report Comment</button>
                </form>
              </div>
            {% endfor %}
          {% else %}
            <p class="muted">No comments yet.</p>
          {% endif %}
        </div>

        <form class="community-comment-form" method="post" action="{{ url_for('main.community_add_comment', post_id=post.id) }}">
          <input type="hidden" name="category" value="{{ selected_category }}" />
          <label for="comment-{{ post.id }}">Add Comment</label>
          <textarea id="comment-{{ post.id }}" name="comment" maxlength="1200" placeholder="Reply to this post..." required></textarea>
          <div style="margin-top: 8px;">
            <button type="submit">Post Comment</button>
          </div>
        </form>
      </article>
    {% endfor %}
    </div>
  {% else %}
    <div class="card">
      <p class="muted">No posts yet in this category. Be the first to share something useful.</p>
    </div>
  {% endif %}

  <script>
    document.querySelectorAll(".copy-link-btn").forEach(function (btn) {
      btn.addEventListener("click", function () {
        const url = btn.getAttribute("data-url");
        if (!url) return;
        navigator.clipboard.writeText(url).then(function () {
          const original = btn.textContent;
          btn.textContent = "Copied";
          setTimeout(function () {
            btn.textContent = original;
          }, 1200);
        });
      });
    });
  </script>
{% endblock %}
