{% extends "base.html" %}
{% block content %}
  {% set mim_logo_url = url_for('static', filename='mim-logo.png') %}
  {% set energy_scale = [
    (1, "Completely drained. Can barely function."),
    (2, "Exhausted. Simple tasks feel heavy."),
    (3, "Very low energy. Foggy and slow."),
    (4, "Low energy. Getting through basics only."),
    (5, "Neutral. Functioning, but not motivated."),
    (6, "Moderate energy. Can focus with effort."),
    (7, "Good energy. Productive and steady."),
    (8, "High energy. Clear, engaged, efficient."),
    (9, "Very high energy. Sharp, motivated, strong drive."),
    (10, "Peak energy. Alert, focused, resilient, ready to take on anything.")
  ] %}
  {% set focus_scale = [
    (1, "Cannot concentrate at all"),
    (2, "Extremely distracted, mind scattered"),
    (3, "Very low focus, frequent interruptions"),
    (4, "Struggling to stay on task"),
    (5, "Moderate focus, easily pulled away"),
    (6, "Can focus with effort"),
    (7, "Steady focus for sustained tasks"),
    (8, "Strong concentration, minimal distraction"),
    (9, "Deep focus, highly productive"),
    (10, "Flow state, fully immersed and efficient")
  ] %}
  {% set mood_scale = [
    (1, "Very low mood, distressed"),
    (2, "Strongly negative"),
    (3, "Down, discouraged"),
    (4, "Slightly low mood"),
    (5, "Neutral"),
    (6, "Mildly positive"),
    (7, "Good mood"),
    (8, "Very positive, upbeat"),
    (9, "Strongly positive, confident"),
    (10, "Exceptionally positive, joyful and grounded")
  ] %}
  {% set stress_scale = [
    (1, "Completely calm"),
    (2, "Very relaxed"),
    (3, "Mild tension"),
    (4, "Slight pressure"),
    (5, "Moderate stress"),
    (6, "Noticeable stress, manageable"),
    (7, "High stress, impacting focus"),
    (8, "Very high stress, difficulty concentrating"),
    (9, "Overwhelmed"),
    (10, "Acute stress, near breaking point")
  ] %}

  {% macro rating_select(field_id, field_name, current_value, options, placeholder) -%}
    <select id="{{ field_id }}" name="{{ field_name }}">
      <option value="" {% if current_value is none %}selected{% endif %}>{{ placeholder }}</option>
      {% for score, text in options %}
        <option value="{{ score }}" {% if current_value == score %}selected{% endif %}>{{ score }} - {{ text }}</option>
      {% endfor %}
    </select>
  {%- endmacro %}

  <style>
    .checkin-page .card {
      padding: 14px;
      margin-bottom: 12px;
    }
    .checkin-page h2 {
      margin-bottom: 10px;
    }
    .checkin-hero-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .checkin-hero-title {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      line-height: 1.15;
      margin: 0;
    }
    .checkin-day-nav {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .checkin-day-nav-link {
      padding: 7px 11px;
      border: 1px solid #d7dee7;
      border-radius: 8px;
      text-decoration: none;
      background: #fff;
      color: #17212b;
      white-space: nowrap;
      font-size: 0.92rem;
    }
    .checkin-day-nav-disabled {
      padding: 7px 11px;
      border: 1px solid #d7dee7;
      border-radius: 8px;
      color: #98a2b3;
      background: #fff;
      white-space: nowrap;
      font-size: 0.92rem;
    }
    .checkin-day-tracking {
      margin: 6px 0 0;
      font-size: 0.95rem;
    }
    .checkin-status {
      margin: 6px 0 0;
      font-size: 0.98rem;
    }
    .checkin-status-ok {
      color: #067647;
    }
    .checkin-status-pending {
      color: #b42318;
    }
    .day-manager-card {
      border-color: #cfe3ff;
      background: #f9fcff;
    }
    .day-manager-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .day-manager-tab {
      padding: 7px 11px;
      border-radius: 8px;
      text-decoration: none;
      color: #17212b;
      background: #fff;
      border: 1px solid #d7dee7;
      white-space: nowrap;
      font-size: 0.92rem;
    }
    .day-manager-tab.active {
      color: #fff;
      background: #0f766e;
      border-color: #0f766e;
    }
    .day-manager-counts {
      margin: 8px 0 0;
      font-size: 0.93rem;
    }
    .checkin-segment-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .checkin-tab-btn {
      padding: 7px 11px;
      border: 1px solid #d7dee7;
      border-radius: 8px;
      background: #fff;
      color: #17212b;
      font-size: 0.92rem;
      cursor: pointer;
    }
    .checkin-segment-progress {
      margin-bottom: 10px;
      font-size: 0.92rem;
      line-height: 1.4;
    }
    .checkin-form-block {
      margin-top: 10px;
    }
    .checkin-form-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .checkin-form-actions button {
      padding: 9px 13px;
    }
    .table-wrap {
      overflow-x: auto;
    }
    .table-compact {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.92rem;
    }
    .table-compact th {
      text-align: left;
      border-bottom: 1px solid #d7dee7;
      padding: 7px;
      white-space: nowrap;
    }
    .table-compact th.align-center {
      text-align: center;
    }
    .table-compact th.align-right {
      text-align: right;
    }
    .table-compact td {
      padding: 7px;
      border-bottom: 1px solid #eef3f8;
      vertical-align: top;
    }
    .table-compact td.align-center {
      text-align: center;
    }
    .table-compact td.align-right {
      text-align: right;
    }
    .table-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .table-actions form {
      margin: 0;
    }
    .table-actions a {
      color: #175cd3;
      text-decoration: underline;
      font-size: 0.92rem;
    }
    .table-actions .delete-link-btn {
      border: none;
      background: transparent;
      color: #b42318;
      text-decoration: underline;
      font-size: 0.92rem;
      padding: 0;
      cursor: pointer;
    }
    .secondary-link-btn {
      display: inline-block;
      padding: 9px 13px;
      background: #fff;
      border: 1px solid #d7dee7;
      border-radius: 8px;
      color: #17212b;
      text-decoration: none;
      font-size: 0.95rem;
    }
    .edit-mode-banner {
      margin: 8px 0 10px;
      padding: 8px 10px;
      border: 1px solid #cfe3ff;
      border-radius: 8px;
      background: #f9fcff;
      font-size: 0.93rem;
    }
    .inline-list {
      margin: 0;
      padding-left: 18px;
      font-size: 0.94rem;
    }
    .inline-list li {
      margin-bottom: 6px;
    }
    .quick-open-link {
      margin-bottom: 10px;
    }
    .quick-open-link a {
      display: inline-block;
      padding: 7px 11px;
      border: 1px solid #d7dee7;
      border-radius: 8px;
      text-decoration: none;
      background: #fff;
      color: #17212b;
      font-size: 0.92rem;
    }
    .mim-field-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .mim-icon-btn {
      border: 1px solid #0f766e;
      background: #e8f7f5;
      color: #0f766e;
      border-radius: 999px;
      width: 38px;
      min-width: 38px;
      height: 38px;
      padding: 0;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .mim-icon-img {
      width: 24px;
      height: 24px;
      object-fit: cover;
      object-position: 50% 26%;
      border-radius: 50%;
    }
    .mim-assist-panel {
      margin-top: 8px;
      border: 1px solid #cfe3ff;
      background: #f9fcff;
      border-radius: 8px;
      padding: 8px;
    }
    .mim-assist-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .mim-assist-row input {
      flex: 1 1 260px;
    }
    .mim-note {
      margin: 7px 0 0;
      font-size: 0.9rem;
      line-height: 1.35;
    }
    .manager-coach-grid {
      display: grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 12px;
      align-items: start;
    }
    .manager-coach-card h2 {
      margin-bottom: 8px;
    }
    .brain-spark-box {
      border: 1px solid #d7dee7;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    .brain-spark-box h3 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .brain-spark-box p {
      margin: 0 0 8px;
      font-size: 0.94rem;
      line-height: 1.35;
    }
    .brain-spark-form {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .brain-spark-form input {
      flex: 1 1 160px;
      min-width: 0;
    }
    .brain-spark-complete {
      color: #067647;
      font-weight: 600;
    }
    .loading-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
      color: var(--muted);
    }
    .inline-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #d7dee7;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: mim-spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    @keyframes mim-spin {
      to {
        transform: rotate(360deg);
      }
    }
    @media (max-width: 860px) {
      .checkin-page .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
      }
      .checkin-hero-title {
        font-size: 1.7rem;
      }
    }
    @media (max-width: 640px) {
      .checkin-page .card {
        padding: 12px;
      }
      .checkin-hero-title {
        font-size: 1.42rem;
      }
      .checkin-day-nav {
        width: 100%;
      }
      .checkin-day-nav-link,
      .checkin-day-nav-disabled {
        flex: 1 1 calc(33.333% - 6px);
        text-align: center;
        padding: 8px 6px;
        font-size: 0.87rem;
      }
      .day-manager-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 2px;
      }
      .day-manager-tab {
        flex: 0 0 auto;
      }
      .checkin-segment-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 2px;
      }
      .checkin-tab-btn {
        flex: 0 0 auto;
      }
      .checkin-page .grid {
        grid-template-columns: 1fr;
      }
      .table-compact {
        min-width: 620px;
      }
      .inline-list {
        padding-left: 16px;
      }
      .mim-assist-row {
        flex-direction: column;
        align-items: stretch;
      }
      .manager-coach-grid {
        grid-template-columns: 1fr;
      }
      .mim-icon-btn {
        min-width: 44px;
      }
    }
  </style>

  <div class="checkin-page">
  <div class="card">
    <div class="checkin-hero-row">
      <div class="checkin-hero-title">
        {{ selected_day_weekday }}, {{ selected_day_pretty }}
      </div>
      <div class="checkin-day-nav">
        <a class="checkin-day-nav-link" href="{{ url_for('main.checkin_form', day=prev_day, view=manager_view) }}">&lt; Prev</a>
        {% if can_go_next %}
          <a class="checkin-day-nav-link" href="{{ url_for('main.checkin_form', day=next_day, view=manager_view) }}">Next &gt;</a>
        {% else %}
          <span class="checkin-day-nav-disabled">Next &gt;</span>
        {% endif %}
        <a class="checkin-day-nav-link" href="{{ url_for('main.checkin_form', day=local_today, view=manager_view) }}">Today</a>
      </div>
    </div>
    <p class="muted checkin-day-tracking">
      Tracking day: <strong>{{ selected_day }}</strong>
      {% if not is_viewing_today %}
        (local today: {{ local_today }})
      {% endif %}
    </p>
    <p class="checkin-status">
      <strong>Check-In Status:</strong>
      {% if selected_day_checked_in %}
        <span class="checkin-status-ok">CHECKED IN FOR THIS DAY</span>
      {% else %}
        <span class="checkin-status-pending">NOT STARTED FOR THIS DAY</span>
      {% endif %}
      {% if is_viewing_today %}
        {% if checked_in_today %}
          <span class="muted">(today ready)</span>
        {% else %}
          <span class="muted">(today pending)</span>
        {% endif %}
      {% endif %}
    </p>
  </div>

  <div class="card day-manager-card">
    <label>Day Manager</label>
    <div class="day-manager-tabs">
      <a class="day-manager-tab {{ 'active' if manager_view == 'checkin' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='checkin') }}">Check-In</a>
      <a class="day-manager-tab {{ 'active' if manager_view == 'meal' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='meal') }}">Log Meal</a>
      <a class="day-manager-tab {{ 'active' if manager_view == 'drink' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='drink') }}">Log Drink</a>
      <a class="day-manager-tab {{ 'active' if manager_view == 'substance' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='substance') }}">Log Substance</a>
      <a class="day-manager-tab {{ 'active' if manager_view == 'activity' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='activity') }}">Log Activity</a>
      <a class="day-manager-tab {{ 'active' if manager_view == 'medications' else '' }}" href="{{ url_for('main.checkin_form', day=selected_day, view='medications') }}">Meds/Supps</a>
    </div>
    <p class="muted day-manager-counts">
      Same-day counts:
      {{ selected_day_meal_count }} meal{{ "" if selected_day_meal_count == 1 else "s" }},
      {{ selected_day_drink_count }} drink{{ "" if selected_day_drink_count == 1 else "s" }},
      {{ selected_day_substance_count }} substance entr{{ "y" if selected_day_substance_count == 1 else "ies" }},
      {{ selected_day_activity_count }} activit{{ "y" if selected_day_activity_count == 1 else "ies" }},
      {{ selected_day_medication_count }} med/supp entr{{ "y" if selected_day_medication_count == 1 else "ies" }}.
    </p>
  </div>

  <div class="card manager-coach-card">
    <div class="manager-coach-grid">
      <div>
        <h2>{{ day_manager_tip.title }}</h2>
        <p>{{ day_manager_tip.tip_text }}</p>
        <p class="muted">{{ day_manager_tip.micro_action }}</p>
        <a class="secondary-link-btn" href="{{ day_manager_tip.cta_url }}">{{ day_manager_tip.cta_label }}</a>
      </div>
      <div class="brain-spark-box">
        <h3>Brain Spark</h3>
        <p>{{ brain_spark.question }}</p>
        {% if brain_spark.is_done %}
          <p class="brain-spark-complete">Completed for this day/view.</p>
        {% endif %}
        <form class="brain-spark-form" method="post" action="{{ url_for('main.checkin_brain_spark_submit') }}">
          <input type="hidden" name="day" value="{{ selected_day }}" />
          <input type="hidden" name="view" value="{{ manager_view }}" />
          <input
            type="text"
            name="brain_answer"
            placeholder="Your answer"
            autocomplete="off"
            {% if brain_spark.is_done %}value="done"{% endif %}
          />
          <button type="submit">Check</button>
        </form>
      </div>
    </div>
  </div>

  {% if manager_view == "checkin" %}
  <div class="card">
    <form method="post" action="{{ url_for('main.checkin_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />

      <div class="checkin-segment-tabs">
        <button type="button" class="checkin-tab-btn" data-tab="sleep">Sleep</button>
        <button type="button" class="checkin-tab-btn" data-tab="morning">Morning</button>
        <button type="button" class="checkin-tab-btn" data-tab="midday">Midday</button>
        <button type="button" class="checkin-tab-btn" data-tab="evening">Evening</button>
        <button type="button" class="checkin-tab-btn" data-tab="overall">Overall</button>
      </div>

      <div class="muted checkin-segment-progress">
        Segment progress:
        Sleep={{ "done" if selected_segments.sleep else "pending" }},
        Morning={{ "done" if selected_segments.morning else "pending" }},
        Midday={{ "done" if selected_segments.midday else "pending" }},
        Evening={{ "done" if selected_segments.evening else "pending" }},
        Overall={{ "done" if selected_segments.overall else "pending" }}
      </div>

      <div class="checkin-tab-panel" data-panel="sleep">
        <h2>Sleep (Night Before)</h2>
        <div class="grid">
          <div>
            <label for="sleep_hours">Sleep Hours</label>
            <input id="sleep_hours" name="sleep_hours" type="number" min="0" max="24" step="0.1" value="{{ record.sleep_hours if record else '' }}" />
          </div>
          <div>
            <label for="sleep_quality">Sleep Quality</label>
            <select id="sleep_quality" name="sleep_quality">
              <option value="" {% if not record or record.sleep_quality is none %}selected{% endif %}>Choose a sleep quality score</option>
              <option value="1" {% if record and record.sleep_quality == 1 %}selected{% endif %}>1 - No sleep</option>
              <option value="2" {% if record and record.sleep_quality == 2 %}selected{% endif %}>2 - &lt;2 hours, fragmented</option>
              <option value="3" {% if record and record.sleep_quality == 3 %}selected{% endif %}>3 - 2-4 hours, very restless</option>
              <option value="4" {% if record and record.sleep_quality == 4 %}selected{% endif %}>4 - 4-5 hours, multiple awakenings</option>
              <option value="5" {% if record and record.sleep_quality == 5 %}selected{% endif %}>5 - 5-6 hours, light/uneven sleep</option>
              <option value="6" {% if record and record.sleep_quality == 6 %}selected{% endif %}>6 - 6-7 hours, some interruptions</option>
              <option value="7" {% if record and record.sleep_quality == 7 %}selected{% endif %}>7 - 7-8 hours, mostly uninterrupted</option>
              <option value="8" {% if record and record.sleep_quality == 8 %}selected{% endif %}>8 - 7-9 hours, solid sleep</option>
              <option value="9" {% if record and record.sleep_quality == 9 %}selected{% endif %}>9 - Deep and restorative, woke refreshed</option>
              <option value="10" {% if record and record.sleep_quality == 10 %}selected{% endif %}>10 - Exceptional sleep, energized and clear all day</option>
            </select>
          </div>
        </div>
        <div class="checkin-form-block">
          <label for="sleep_notes">Sleep Notes</label>
          <textarea id="sleep_notes" name="sleep_notes" placeholder="Wakeups, latency, dreams, disruptions...">{{ record.sleep_notes if record else '' }}</textarea>
        </div>
      </div>

      <div class="checkin-tab-panel" data-panel="morning" style="display: none;">
        <h2>Morning</h2>
        <div class="grid">
          <div>
            <label for="morning_energy">Energy</label>
            {{ rating_select("morning_energy", "morning_energy", record.morning_energy if record else none, energy_scale, "Select energy level") }}
          </div>
          <div>
            <label for="morning_focus">Focus Level</label>
            {{ rating_select("morning_focus", "morning_focus", record.morning_focus if record else none, focus_scale, "Select focus level") }}
          </div>
          <div>
            <label for="morning_mood">Mood Level</label>
            {{ rating_select("morning_mood", "morning_mood", record.morning_mood if record else none, mood_scale, "Select mood level") }}
          </div>
          <div>
            <label for="morning_stress">Stress Level</label>
            {{ rating_select("morning_stress", "morning_stress", record.morning_stress if record else none, stress_scale, "Select stress level") }}
          </div>
          <div>
            <label for="morning_weight">Morning Weight ({{ checkin_weight_unit }})</label>
            <input id="morning_weight" name="morning_weight" type="number" min="0" step="0.1" value="{{ morning_weight_display if morning_weight_display is not none else '' }}" />
          </div>
        </div>
        <div class="checkin-form-block">
          <label for="morning_notes">Morning Notes</label>
          <textarea id="morning_notes" name="morning_notes">{{ record.morning_notes if record else '' }}</textarea>
        </div>
      </div>

      <div class="checkin-tab-panel" data-panel="midday" style="display: none;">
        <h2>Midday</h2>
        <div class="grid">
          <div>
            <label for="midday_energy">Energy</label>
            {{ rating_select("midday_energy", "midday_energy", record.midday_energy if record else none, energy_scale, "Select energy level") }}
          </div>
          <div>
            <label for="midday_focus">Focus Level</label>
            {{ rating_select("midday_focus", "midday_focus", record.midday_focus if record else none, focus_scale, "Select focus level") }}
          </div>
          <div>
            <label for="midday_mood">Mood Level</label>
            {{ rating_select("midday_mood", "midday_mood", record.midday_mood if record else none, mood_scale, "Select mood level") }}
          </div>
          <div>
            <label for="midday_stress">Stress Level</label>
            {{ rating_select("midday_stress", "midday_stress", record.midday_stress if record else none, stress_scale, "Select stress level") }}
          </div>
        </div>
        <div class="checkin-form-block">
          <label for="midday_notes">Midday Notes</label>
          <textarea id="midday_notes" name="midday_notes">{{ record.midday_notes if record else '' }}</textarea>
        </div>
      </div>

      <div class="checkin-tab-panel" data-panel="evening" style="display: none;">
        <h2>Evening</h2>
        <div class="grid">
          <div>
            <label for="evening_energy">Energy</label>
            {{ rating_select("evening_energy", "evening_energy", record.evening_energy if record else none, energy_scale, "Select energy level") }}
          </div>
          <div>
            <label for="evening_focus">Focus Level</label>
            {{ rating_select("evening_focus", "evening_focus", record.evening_focus if record else none, focus_scale, "Select focus level") }}
          </div>
          <div>
            <label for="evening_mood">Mood Level</label>
            {{ rating_select("evening_mood", "evening_mood", record.evening_mood if record else none, mood_scale, "Select mood level") }}
          </div>
          <div>
            <label for="evening_stress">Stress Level</label>
            {{ rating_select("evening_stress", "evening_stress", record.evening_stress if record else none, stress_scale, "Select stress level") }}
          </div>
        </div>
        <div class="checkin-form-block">
          <label for="evening_notes">Evening Notes</label>
          <textarea id="evening_notes" name="evening_notes">{{ record.evening_notes if record else '' }}</textarea>
        </div>
      </div>

      <div class="checkin-tab-panel" data-panel="overall" style="display: none;">
        <h2>Overall Day Snapshot</h2>
        <div class="grid">
          <div>
            <label for="energy">Overall Energy</label>
            {{ rating_select("energy", "energy", record.energy if record else none, energy_scale, "Select overall energy level") }}
          </div>
          <div>
            <label for="focus">Overall Focus Level</label>
            {{ rating_select("focus", "focus", record.focus if record else none, focus_scale, "Select overall focus level") }}
          </div>
          <div>
            <label for="mood">Overall Mood Level</label>
            {{ rating_select("mood", "mood", record.mood if record else none, mood_scale, "Select overall mood level") }}
          </div>
          <div>
            <label for="stress">Overall Stress Level</label>
            {{ rating_select("stress", "stress", record.stress if record else none, stress_scale, "Select overall stress level") }}
          </div>
          <div>
            <label for="anxiety">Anxiety (1-10)</label>
            <input id="anxiety" name="anxiety" type="number" min="1" max="10" value="{{ record.anxiety if record else '' }}" />
          </div>
          <div>
            <label for="productivity">Productivity (1-10)</label>
            <input id="productivity" name="productivity" type="number" min="1" max="10" value="{{ record.productivity if record else '' }}" />
          </div>
          <div>
            <label for="workout_timing">Workout Timing</label>
            <input id="workout_timing" name="workout_timing" placeholder="e.g., 7:00am strength" value="{{ record.workout_timing if record else '' }}" />
          </div>
          <div>
            <label for="workout_intensity">Workout Intensity (1-10)</label>
            <input id="workout_intensity" name="workout_intensity" type="number" min="1" max="10" value="{{ record.workout_intensity if record else '' }}" />
          </div>
          <div>
            <label for="alcohol_drinks">Alcohol (drinks)</label>
            <input id="alcohol_drinks" name="alcohol_drinks" type="number" min="0" step="0.5" value="{{ record.alcohol_drinks if record else '' }}" />
          </div>
          <div>
            <label for="headache">Headache Severity (0-10)</label>
            <input id="headache" name="headache" type="number" min="0" max="10" value="{{ record.symptoms.get('headache') if record and record.symptoms else '' }}" />
          </div>
          <div>
            <label for="stomach">Stomach Severity (0-10)</label>
            <input id="stomach" name="stomach" type="number" min="0" max="10" value="{{ record.symptoms.get('stomach') if record and record.symptoms else '' }}" />
          </div>
          <div>
            <label for="nausea">Nausea Severity (0-10)</label>
            <input id="nausea" name="nausea" type="number" min="0" max="10" value="{{ record.symptoms.get('nausea') if record and record.symptoms else '' }}" />
          </div>
          <div>
            <label for="bm_count">BM Count</label>
            <input id="bm_count" name="bm_count" type="number" min="0" value="{{ record.digestion.get('bm_count') if record and record.digestion else '' }}" />
          </div>
          <div>
            <label for="digestion_issues">Digestion Issues (comma-separated)</label>
            <input id="digestion_issues" name="digestion_issues" placeholder="bloat, cramp, reflux" value="{{ (record.digestion.get('issues') | join(', ')) if record and record.digestion and record.digestion.get('issues') else '' }}" />
          </div>
        </div>

        <div class="checkin-form-block">
          <label for="accomplishments">Accomplishments</label>
          <textarea id="accomplishments" name="accomplishments">{{ record.accomplishments if record else '' }}</textarea>
        </div>
        <div class="checkin-form-block">
          <label for="notes">Overall Notes</label>
          <textarea id="notes" name="notes">{{ record.notes if record else '' }}</textarea>
        </div>
      </div>

      <div class="checkin-form-actions">
        <button type="submit">Save Check-In</button>
      </div>
    </form>
  </div>
  {% elif manager_view == "meal" %}
  <div class="card">
    <h2>Meals For {{ selected_day }}</h2>
    <p class="muted">Quick-log a meal for this day, or open full meal tools for builder/search/photos.</p>
    {% if edit_meal_entry %}
      <div class="edit-mode-banner">
        Editing meal entry from {{ edit_meal_entry.eaten_at.strftime("%H:%M") }}. Update values, then press Update Meal Entry.
      </div>
    {% endif %}
    <div class="quick-open-link">
      <a href="{{ url_for('main.meal_form', day=selected_day) }}">Open Full Meal Logger</a>
    </div>
    <form method="post" action="{{ url_for('main.checkin_meal_quick_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />
      <input type="hidden" name="view" value="meal" />
      <input type="hidden" name="is_beverage" value="0" />
      {% if edit_meal_entry %}
        <input type="hidden" name="edit_meal_id" value="{{ edit_meal_entry.id }}" />
      {% endif %}
      <div class="grid">
        <div>
          <label for="meal_favorite_id">Quick Favorite</label>
          <select id="meal_favorite_id" name="favorite_id">
            <option value="">Choose a meal favorite</option>
            {% for favorite in meal_quick_favorites %}
              <option
                value="{{ favorite.id }}"
                data-label="{{ favorite.label }}"
                data-description="{{ favorite.description }}"
                data-portion_notes="{{ favorite.portion_notes }}"
                data-calories="{{ favorite.calories }}"
                data-protein_g="{{ favorite.protein_g }}"
                data-carbs_g="{{ favorite.carbs_g }}"
                data-fat_g="{{ favorite.fat_g }}"
              >{{ favorite.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="meal_eaten_at">Time</label>
          <input
            id="meal_eaten_at"
            name="eaten_at"
            type="datetime-local"
            value="{{ edit_meal_entry.eaten_at.strftime('%Y-%m-%dT%H:%M') if edit_meal_entry else default_entry_datetime }}"
            required
          />
        </div>
        <div>
          <label for="meal_label">Label</label>
          <input
            id="meal_label"
            name="label"
            value="{{ edit_meal_entry.label if edit_meal_entry else '' }}"
            placeholder="Breakfast / Lunch / Dinner / Snack"
          />
        </div>
        <div>
          <label for="meal_description">Meal Name</label>
          <div class="mim-field-row">
            <input
              id="meal_description"
              name="description"
              value="{{ edit_meal_entry.description if edit_meal_entry else '' }}"
              placeholder="e.g., Turkey sandwich"
              required
            />
            <button id="meal_mim_toggle" class="mim-icon-btn" type="button" title="Ask MIM for help">
              <img class="mim-icon-img" src="{{ mim_logo_url }}" alt="MIM" />
            </button>
          </div>
          <div id="meal_mim_panel" class="mim-assist-panel" style="display: none;">
            <div class="mim-assist-row">
              <input id="meal_mim_prompt" type="text" placeholder="Tell MIM what was in it (ingredients + amounts)" />
              <button id="meal_mim_run" type="button">Ask MIM</button>
            </div>
            <div id="meal_mim_loading" class="loading-row" style="display: none;">
              <span class="inline-spinner"></span>
              <span>MIM is estimating nutrition...</span>
            </div>
            <p id="meal_mim_status" class="muted mim-note"></p>
          </div>
        </div>
        <div>
          <label for="meal_portion_notes">Portion Notes</label>
          <input
            id="meal_portion_notes"
            name="portion_notes"
            value="{{ edit_meal_entry.portion_notes if edit_meal_entry else '' }}"
            placeholder="1 bowl, 2 slices..."
          />
        </div>
        <div>
          <label for="meal_calories">Calories</label>
          <input
            id="meal_calories"
            name="calories"
            type="number"
            min="0"
            value="{{ edit_meal_entry.calories if edit_meal_entry and edit_meal_entry.calories is not none else '' }}"
          />
        </div>
        <div>
          <label for="meal_protein_g">Protein (g)</label>
          <input
            id="meal_protein_g"
            name="protein_g"
            type="number"
            min="0"
            step="0.1"
            value="{{ edit_meal_entry.protein_g if edit_meal_entry and edit_meal_entry.protein_g is not none else '' }}"
          />
        </div>
        <div>
          <label for="meal_carbs_g">Carbs (g)</label>
          <input
            id="meal_carbs_g"
            name="carbs_g"
            type="number"
            min="0"
            step="0.1"
            value="{{ edit_meal_entry.carbs_g if edit_meal_entry and edit_meal_entry.carbs_g is not none else '' }}"
          />
        </div>
        <div>
          <label for="meal_fat_g">Fat (g)</label>
          <input
            id="meal_fat_g"
            name="fat_g"
            type="number"
            min="0"
            step="0.1"
            value="{{ edit_meal_entry.fat_g if edit_meal_entry and edit_meal_entry.fat_g is not none else '' }}"
          />
        </div>
      </div>
      <div class="grid" style="margin-top: 8px;">
        <div>
          <label for="meal_save_favorite">Favorite</label>
          <label style="font-weight: 500; margin-bottom: 0;">
            <input id="meal_save_favorite" name="save_favorite" type="checkbox" />
            Save this as favorite
          </label>
        </div>
        <div>
          <label for="meal_favorite_name">Favorite Name (optional)</label>
          <input id="meal_favorite_name" name="favorite_name" placeholder="e.g., weekday lunch" />
        </div>
      </div>
      <div class="checkin-form-actions">
        <button type="submit">{{ "Update Meal Entry" if edit_meal_entry else "Save Meal Entry" }}</button>
        {% if edit_meal_entry %}
          <a class="secondary-link-btn" href="{{ url_for('main.checkin_form', day=selected_day, view='meal') }}">Cancel Edit</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Meals Logged</h2>
    {% if day_food_entries %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Time</th>
              <th>Item</th>
              <th>Portion</th>
              <th class="align-right">Calories</th>
              <th class="align-right">P/C/F</th>
              <th class="align-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for meal in day_food_entries %}
              <tr>
                <td>{{ meal.eaten_at.strftime("%H:%M") }}</td>
                <td>{{ meal.description or (meal.food_item.display_name() if meal.food_item else "Meal") }}</td>
                <td>{{ meal.portion_notes or "n/a" }}</td>
                <td class="align-right">{{ meal.calories if meal.calories is not none else "-" }}</td>
                <td class="align-right">
                  {{ meal.protein_g if meal.protein_g is not none else "-" }}/{{ meal.carbs_g if meal.carbs_g is not none else "-" }}/{{ meal.fat_g if meal.fat_g is not none else "-" }}
                </td>
                <td class="align-right">
                  <div class="table-actions">
                    <a href="{{ url_for('main.checkin_form', day=selected_day, view='meal', edit_meal_id=meal.id) }}">Edit</a>
                    <form
                      method="post"
                      action="{{ url_for('main.checkin_meal_quick_delete', meal_id=meal.id) }}"
                      onsubmit="return confirm('Delete this meal entry?');"
                    >
                      <input type="hidden" name="day" value="{{ selected_day }}" />
                      <input type="hidden" name="view" value="meal" />
                      <button class="delete-link-btn" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No meals logged for this day yet.</p>
    {% endif %}
  </div>
  {% elif manager_view == "drink" %}
  <div class="card">
    <h2>Drinks For {{ selected_day }}</h2>
    <p class="muted">Quick-log drinks separately to make caffeine/hydration timing easier to track.</p>
    {% if edit_drink_entry %}
      <div class="edit-mode-banner">
        Editing drink entry from {{ edit_drink_entry.eaten_at.strftime("%H:%M") }}. Update values, then press Update Drink Entry.
      </div>
    {% endif %}
    <form method="post" action="{{ url_for('main.checkin_meal_quick_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />
      <input type="hidden" name="view" value="drink" />
      <input type="hidden" name="is_beverage" value="1" />
      <input type="hidden" name="label" value="Drink" />
      {% if edit_drink_entry %}
        <input type="hidden" name="edit_meal_id" value="{{ edit_drink_entry.id }}" />
      {% endif %}
      <div class="grid">
        <div>
          <label for="drink_favorite_id">Quick Favorite</label>
          <select id="drink_favorite_id" name="favorite_id">
            <option value="">Choose a drink favorite</option>
            {% for favorite in drink_quick_favorites %}
              <option
                value="{{ favorite.id }}"
                data-description="{{ favorite.description }}"
                data-portion_notes="{{ favorite.portion_notes }}"
                data-calories="{{ favorite.calories }}"
                data-sugar_g="{{ favorite.sugar_g }}"
                data-caffeine_mg="{{ favorite.caffeine_mg }}"
              >{{ favorite.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="drink_eaten_at">Time</label>
          <input
            id="drink_eaten_at"
            name="eaten_at"
            type="datetime-local"
            value="{{ edit_drink_entry.eaten_at.strftime('%Y-%m-%dT%H:%M') if edit_drink_entry else default_entry_datetime }}"
            required
          />
        </div>
        <div>
          <label for="drink_description">Drink Name</label>
          <div class="mim-field-row">
            <input
              id="drink_description"
              name="description"
              value="{{ edit_drink_entry.description if edit_drink_entry else '' }}"
              placeholder="e.g., Iced coffee, Diet soda"
              required
            />
            <button id="drink_mim_toggle" class="mim-icon-btn" type="button" title="Ask MIM for help">
              <img class="mim-icon-img" src="{{ mim_logo_url }}" alt="MIM" />
            </button>
          </div>
          <div id="drink_mim_panel" class="mim-assist-panel" style="display: none;">
            <div class="mim-assist-row">
              <input id="drink_mim_prompt" type="text" placeholder="Tell MIM ingredients and amounts (for example: 12 oz tea + 1 tbsp honey)" />
              <button id="drink_mim_run" type="button">Ask MIM</button>
            </div>
            <div id="drink_mim_loading" class="loading-row" style="display: none;">
              <span class="inline-spinner"></span>
              <span>MIM is estimating drink nutrition...</span>
            </div>
            <p id="drink_mim_status" class="muted mim-note"></p>
          </div>
        </div>
        <div>
          <label for="drink_portion_notes">Volume / Portion</label>
          <input
            id="drink_portion_notes"
            name="portion_notes"
            value="{{ edit_drink_entry.portion_notes if edit_drink_entry else '' }}"
            placeholder="12 oz, 1 can, 500 ml..."
          />
        </div>
        <div>
          <label for="drink_caffeine_mg">Caffeine (mg)</label>
          <input
            id="drink_caffeine_mg"
            name="caffeine_mg"
            type="number"
            min="0"
            step="0.1"
            value="{{ edit_drink_entry.caffeine_mg if edit_drink_entry and edit_drink_entry.caffeine_mg is not none else '' }}"
          />
        </div>
        <div>
          <label for="drink_calories">Calories</label>
          <input
            id="drink_calories"
            name="calories"
            type="number"
            min="0"
            value="{{ edit_drink_entry.calories if edit_drink_entry and edit_drink_entry.calories is not none else '' }}"
          />
        </div>
        <div>
          <label for="drink_sugar_g">Sugar (g)</label>
          <input
            id="drink_sugar_g"
            name="sugar_g"
            type="number"
            min="0"
            step="0.1"
            value="{{ edit_drink_entry.sugar_g if edit_drink_entry and edit_drink_entry.sugar_g is not none else '' }}"
          />
        </div>
      </div>
      <div class="grid" style="margin-top: 8px;">
        <div>
          <label for="drink_save_favorite">Favorite</label>
          <label style="font-weight: 500; margin-bottom: 0;">
            <input id="drink_save_favorite" name="save_favorite" type="checkbox" />
            Save this as favorite
          </label>
        </div>
        <div>
          <label for="drink_favorite_name">Favorite Name (optional)</label>
          <input id="drink_favorite_name" name="favorite_name" placeholder="e.g., afternoon green tea" />
        </div>
      </div>
      <div class="checkin-form-actions">
        <button type="submit">{{ "Update Drink Entry" if edit_drink_entry else "Save Drink Entry" }}</button>
        {% if edit_drink_entry %}
          <a class="secondary-link-btn" href="{{ url_for('main.checkin_form', day=selected_day, view='drink') }}">Cancel Edit</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Drinks Logged</h2>
    {% if day_drink_entries %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Time</th>
              <th>Drink</th>
              <th>Portion</th>
              <th class="align-right">Caffeine</th>
              <th class="align-right">Calories</th>
              <th class="align-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for meal in day_drink_entries %}
              <tr>
                <td>{{ meal.eaten_at.strftime("%H:%M") }}</td>
                <td>{{ meal.description or (meal.food_item.display_name() if meal.food_item else "Drink") }}</td>
                <td>{{ meal.portion_notes or "n/a" }}</td>
                <td class="align-right">{{ meal.caffeine_mg if meal.caffeine_mg is not none else "-" }}</td>
                <td class="align-right">{{ meal.calories if meal.calories is not none else "-" }}</td>
                <td class="align-right">
                  <div class="table-actions">
                    <a href="{{ url_for('main.checkin_form', day=selected_day, view='drink', edit_drink_id=meal.id) }}">Edit</a>
                    <form
                      method="post"
                      action="{{ url_for('main.checkin_meal_quick_delete', meal_id=meal.id) }}"
                      onsubmit="return confirm('Delete this drink entry?');"
                    >
                      <input type="hidden" name="day" value="{{ selected_day }}" />
                      <input type="hidden" name="view" value="drink" />
                      <button class="delete-link-btn" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No drinks logged for this day yet.</p>
    {% endif %}
  </div>
  {% elif manager_view == "substance" %}
  <div class="card">
    <h2>Substances For {{ selected_day }}</h2>
    {% if edit_substance_entry %}
      <div class="edit-mode-banner">
        Editing substance entry from {{ edit_substance_entry.taken_at.strftime("%H:%M") }}. Update values, then press Update Substance Entry.
      </div>
    {% endif %}
    <form method="post" action="{{ url_for('main.checkin_substance_quick_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />
      <input type="hidden" name="view" value="substance" />
      {% if edit_substance_entry %}
        <input type="hidden" name="edit_entry_id" value="{{ edit_substance_entry.id }}" />
      {% endif %}
      <div class="grid">
        <div>
          <label for="sub_favorite_id">Quick Favorite</label>
          <select id="sub_favorite_id" name="favorite_id">
            <option value="">Choose a substance favorite</option>
            {% for favorite in substance_quick_favorites %}
              <option
                value="{{ favorite.id }}"
                data-kind="{{ favorite.kind }}"
                data-amount="{{ favorite.amount }}"
                data-notes="{{ favorite.notes }}"
              >{{ favorite.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="sub_taken_at">Time</label>
          <input
            id="sub_taken_at"
            name="taken_at"
            type="datetime-local"
            value="{{ edit_substance_entry.taken_at.strftime('%Y-%m-%dT%H:%M') if edit_substance_entry else default_entry_datetime }}"
            required
          />
        </div>
        <div>
          <label for="sub_kind">Type</label>
          <select id="sub_kind" name="kind" required>
            <option value="" {% if not edit_substance_kind_value %}selected{% endif %}>Choose one</option>
            <option value="alcohol" {% if edit_substance_kind_value == "alcohol" %}selected{% endif %}>Alcohol</option>
            <option value="caffeine" {% if edit_substance_kind_value == "caffeine" %}selected{% endif %}>Caffeine</option>
            <option value="nicotine" {% if edit_substance_kind_value == "nicotine" %}selected{% endif %}>Nicotine</option>
            <option value="other" {% if edit_substance_kind_value == "other" %}selected{% endif %}>Other</option>
          </select>
        </div>
        <div>
          <label for="sub_amount">Amount</label>
          <div class="mim-field-row">
            <input
              id="sub_amount"
              name="amount"
              value="{{ edit_substance_amount_value if edit_substance_entry else '' }}"
              placeholder="2 beers, 200mg..."
              required
            />
            <button id="sub_mim_toggle" class="mim-icon-btn" type="button" title="Ask MIM for help">
              <img class="mim-icon-img" src="{{ mim_logo_url }}" alt="MIM" />
            </button>
          </div>
        </div>
      </div>
      <div id="sub_mim_panel" class="mim-assist-panel" style="display: none;">
        <div class="mim-assist-row">
          <input id="sub_mim_prompt" type="text" placeholder="Tell MIM what you took (for example: 2 beers, or 200mg caffeine)" />
          <button id="sub_mim_run" type="button">Ask MIM</button>
        </div>
        <div id="sub_mim_loading" class="loading-row" style="display: none;">
          <span class="inline-spinner"></span>
          <span>MIM is drafting your substance entry...</span>
        </div>
        <p id="sub_mim_status" class="muted mim-note"></p>
      </div>
      <div class="checkin-form-block">
        <label for="sub_notes">Notes</label>
        <textarea id="sub_notes" name="notes">{{ edit_substance_entry.notes if edit_substance_entry else '' }}</textarea>
      </div>
      <div class="grid" style="margin-top: 8px;">
        <div>
          <label for="sub_save_favorite">Favorite</label>
          <label style="font-weight: 500; margin-bottom: 0;">
            <input id="sub_save_favorite" name="save_favorite" type="checkbox" />
            Save this as favorite
          </label>
        </div>
        <div>
          <label for="sub_favorite_name">Favorite Name (optional)</label>
          <input id="sub_favorite_name" name="favorite_name" placeholder="e.g., evening nicotine pouch" />
        </div>
      </div>
      <div class="checkin-form-actions">
        <button type="submit">{{ "Update Substance Entry" if edit_substance_entry else "Save Substance Entry" }}</button>
        {% if edit_substance_entry %}
          <a class="secondary-link-btn" href="{{ url_for('main.checkin_form', day=selected_day, view='substance') }}">Cancel Edit</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Substance Entries</h2>
    {% if day_substance_entries %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Notes</th>
              <th class="align-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in day_substance_entries %}
              <tr>
                <td>{{ entry.taken_at.strftime("%H:%M") }}</td>
                <td>{{ entry.kind }}</td>
                <td>{{ entry.amount or "n/a" }}</td>
                <td>{{ entry.notes or "-" }}</td>
                <td class="align-right">
                  <div class="table-actions">
                    <a href="{{ url_for('main.checkin_form', day=selected_day, view='substance', edit_entry_id=entry.id) }}">Edit</a>
                    <form
                      method="post"
                      action="{{ url_for('main.checkin_substance_quick_delete', entry_id=entry.id) }}"
                      onsubmit="return confirm('Delete this substance entry?');"
                    >
                      <input type="hidden" name="day" value="{{ selected_day }}" />
                      <input type="hidden" name="view" value="substance" />
                      <button class="delete-link-btn" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No substance entries for this day yet.</p>
    {% endif %}
  </div>
  {% elif manager_view == "activity" %}
  <div class="card">
    <h2>Activity For {{ selected_day }}</h2>
    {% if edit_substance_entry %}
      <div class="edit-mode-banner">
        Editing activity entry from {{ edit_substance_entry.taken_at.strftime("%H:%M") }}. Update values, then press Update Activity Entry.
      </div>
    {% endif %}
    <form method="post" action="{{ url_for('main.checkin_substance_quick_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />
      <input type="hidden" name="view" value="activity" />
      <input type="hidden" name="kind" value="activity" />
      {% if edit_substance_entry %}
        <input type="hidden" name="edit_entry_id" value="{{ edit_substance_entry.id }}" />
      {% endif %}
      <div class="grid">
        <div>
          <label for="act_favorite_id">Quick Favorite</label>
          <select id="act_favorite_id" name="favorite_id">
            <option value="">Choose an activity favorite</option>
            {% for favorite in activity_quick_favorites %}
              <option
                value="{{ favorite.id }}"
                data-activity_type="{{ favorite.activity_type }}"
                data-duration_min="{{ favorite.duration_min }}"
                data-intensity="{{ favorite.intensity }}"
                data-notes="{{ favorite.notes }}"
              >{{ favorite.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="act_taken_at">Time</label>
          <input
            id="act_taken_at"
            name="taken_at"
            type="datetime-local"
            value="{{ edit_substance_entry.taken_at.strftime('%Y-%m-%dT%H:%M') if edit_substance_entry else default_entry_datetime }}"
            required
          />
        </div>
        <div>
          <label for="activity_type">Activity</label>
          <div class="mim-field-row">
            <input
              id="activity_type"
              name="activity_type"
              value="{{ edit_activity_type_value if edit_substance_entry else '' }}"
              placeholder="Run, lift, walk, HIIT..."
              required
            />
            <button id="act_mim_toggle" class="mim-icon-btn" type="button" title="Ask MIM for help">
              <img class="mim-icon-img" src="{{ mim_logo_url }}" alt="MIM" />
            </button>
          </div>
        </div>
        <div>
          <label for="duration_min">Duration (min)</label>
          <input
            id="duration_min"
            name="duration_min"
            type="number"
            min="1"
            value="{{ edit_activity_duration_value if edit_substance_entry and edit_activity_duration_value is not none else '' }}"
            required
          />
        </div>
        <div>
          <label for="intensity">Intensity (1-10)</label>
          <input
            id="intensity"
            name="intensity"
            type="number"
            min="1"
            max="10"
            value="{{ edit_activity_intensity_value if edit_substance_entry and edit_activity_intensity_value is not none else '' }}"
          />
        </div>
      </div>
      <div id="act_mim_panel" class="mim-assist-panel" style="display: none;">
        <div class="mim-assist-row">
          <input id="act_mim_prompt" type="text" placeholder="Tell MIM your workout (example: 35 min run at intensity 7/10)" />
          <button id="act_mim_run" type="button">Ask MIM</button>
        </div>
        <div id="act_mim_loading" class="loading-row" style="display: none;">
          <span class="inline-spinner"></span>
          <span>MIM is drafting your activity entry...</span>
        </div>
        <p id="act_mim_status" class="muted mim-note"></p>
      </div>
      <div class="checkin-form-block">
        <label for="act_notes">Notes</label>
        <textarea id="act_notes" name="notes">{{ edit_substance_entry.notes if edit_substance_entry else '' }}</textarea>
      </div>
      <div class="grid" style="margin-top: 8px;">
        <div>
          <label for="act_save_favorite">Favorite</label>
          <label style="font-weight: 500; margin-bottom: 0;">
            <input id="act_save_favorite" name="save_favorite" type="checkbox" />
            Save this as favorite
          </label>
        </div>
        <div>
          <label for="act_favorite_name">Favorite Name (optional)</label>
          <input id="act_favorite_name" name="favorite_name" placeholder="e.g., morning walk" />
        </div>
      </div>
      <div class="checkin-form-actions">
        <button type="submit">{{ "Update Activity Entry" if edit_substance_entry else "Save Activity Entry" }}</button>
        {% if edit_substance_entry %}
          <a class="secondary-link-btn" href="{{ url_for('main.checkin_form', day=selected_day, view='activity') }}">Cancel Edit</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Activity Entries</h2>
    {% if day_activity_entries %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Time</th>
              <th>Activity</th>
              <th>Notes</th>
              <th class="align-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in day_activity_entries %}
              <tr>
                <td>{{ entry.taken_at.strftime("%H:%M") }}</td>
                <td>{{ entry.amount or "n/a" }}</td>
                <td>{{ entry.notes or "-" }}</td>
                <td class="align-right">
                  <div class="table-actions">
                    <a href="{{ url_for('main.checkin_form', day=selected_day, view='activity', edit_entry_id=entry.id) }}">Edit</a>
                    <form
                      method="post"
                      action="{{ url_for('main.checkin_substance_quick_delete', entry_id=entry.id) }}"
                      onsubmit="return confirm('Delete this activity entry?');"
                    >
                      <input type="hidden" name="day" value="{{ selected_day }}" />
                      <input type="hidden" name="view" value="activity" />
                      <button class="delete-link-btn" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No activity entries for this day yet.</p>
    {% endif %}
  </div>
  {% elif manager_view == "medications" %}
  <div class="card">
    <h2>Medications / Supplements For {{ selected_day }}</h2>
    {% if edit_substance_entry %}
      <div class="edit-mode-banner">
        Editing meds/supp entry from {{ edit_substance_entry.taken_at.strftime("%H:%M") }}. Update values, then press Update Med/Supp Entry.
      </div>
    {% endif %}
    <form method="post" action="{{ url_for('main.checkin_substance_quick_save') }}">
      <input type="hidden" name="day" value="{{ selected_day }}" />
      <input type="hidden" name="view" value="medications" />
      {% if edit_substance_entry %}
        <input type="hidden" name="edit_entry_id" value="{{ edit_substance_entry.id }}" />
      {% endif %}
      <div class="grid">
        <div>
          <label for="med_favorite_id">Quick Favorite</label>
          <select id="med_favorite_id" name="favorite_id">
            <option value="">Choose a meds/supp favorite</option>
            {% for favorite in medication_quick_favorites %}
              <option
                value="{{ favorite.id }}"
                data-kind="{{ favorite.kind }}"
                data-med_name="{{ favorite.med_name }}"
                data-dose="{{ favorite.dose }}"
                data-notes="{{ favorite.notes }}"
              >{{ favorite.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="med_taken_at">Time</label>
          <input
            id="med_taken_at"
            name="taken_at"
            type="datetime-local"
            value="{{ edit_substance_entry.taken_at.strftime('%Y-%m-%dT%H:%M') if edit_substance_entry else default_entry_datetime }}"
            required
          />
        </div>
        <div>
          <label for="med_kind">Type</label>
          <select id="med_kind" name="kind" required>
            <option value="medication" {% if not edit_med_kind_value or edit_med_kind_value == "medication" %}selected{% endif %}>Medication</option>
            <option value="supplement" {% if edit_med_kind_value == "supplement" %}selected{% endif %}>Supplement</option>
          </select>
        </div>
        <div>
          <label for="med_name">Name</label>
          <div class="mim-field-row">
            <input
              id="med_name"
              name="med_name"
              value="{{ edit_med_name_value if edit_substance_entry else '' }}"
              placeholder="e.g., Magnesium glycinate"
              required
            />
            <button id="med_mim_toggle" class="mim-icon-btn" type="button" title="Ask MIM for help">
              <img class="mim-icon-img" src="{{ mim_logo_url }}" alt="MIM" />
            </button>
          </div>
        </div>
        <div>
          <label for="dose">Dose</label>
          <input id="dose" name="dose" value="{{ edit_med_dose_value if edit_substance_entry else '' }}" placeholder="e.g., 200 mg" />
        </div>
      </div>
      <div id="med_mim_panel" class="mim-assist-panel" style="display: none;">
        <div class="mim-assist-row">
          <input id="med_mim_prompt" type="text" placeholder="Tell MIM what you took (example: 200 mg magnesium supplement)" />
          <button id="med_mim_run" type="button">Ask MIM</button>
        </div>
        <div id="med_mim_loading" class="loading-row" style="display: none;">
          <span class="inline-spinner"></span>
          <span>MIM is drafting your meds/supps entry...</span>
        </div>
        <p id="med_mim_status" class="muted mim-note"></p>
      </div>
      <div class="checkin-form-block">
        <label for="med_notes">Notes</label>
        <textarea id="med_notes" name="notes">{{ edit_substance_entry.notes if edit_substance_entry else '' }}</textarea>
      </div>
      <div class="grid" style="margin-top: 8px;">
        <div>
          <label for="med_save_favorite">Favorite</label>
          <label style="font-weight: 500; margin-bottom: 0;">
            <input id="med_save_favorite" name="save_favorite" type="checkbox" />
            Save this as favorite
          </label>
        </div>
        <div>
          <label for="med_favorite_name">Favorite Name (optional)</label>
          <input id="med_favorite_name" name="favorite_name" placeholder="e.g., nightly magnesium" />
        </div>
      </div>
      <div class="checkin-form-actions">
        <button type="submit">{{ "Update Med/Supp Entry" if edit_substance_entry else "Save Med/Supp Entry" }}</button>
        {% if edit_substance_entry %}
          <a class="secondary-link-btn" href="{{ url_for('main.checkin_form', day=selected_day, view='medications') }}">Cancel Edit</a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="card">
    <h2>Medication/Supplement Entries</h2>
    {% if day_medication_entries %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Details</th>
              <th>Notes</th>
              <th class="align-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in day_medication_entries %}
              <tr>
                <td>{{ entry.taken_at.strftime("%H:%M") }}</td>
                <td>{{ entry.kind }}</td>
                <td>{{ entry.amount or "n/a" }}</td>
                <td>{{ entry.notes or "-" }}</td>
                <td class="align-right">
                  <div class="table-actions">
                    <a href="{{ url_for('main.checkin_form', day=selected_day, view='medications', edit_entry_id=entry.id) }}">Edit</a>
                    <form
                      method="post"
                      action="{{ url_for('main.checkin_substance_quick_delete', entry_id=entry.id) }}"
                      onsubmit="return confirm('Delete this meds/supp entry?');"
                    >
                      <input type="hidden" name="day" value="{{ selected_day }}" />
                      <input type="hidden" name="view" value="medications" />
                      <button class="delete-link-btn" type="submit">Delete</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No medication/supplement entries for this day yet.</p>
    {% endif %}
  </div>
  {% endif %}

  {% if manager_view == "checkin" %}
  <div class="card">
    <h2>Recent Check-In History</h2>
    {% if history_rows %}
      <div class="table-wrap">
        <table class="table-compact">
          <thead>
            <tr>
              <th>Day</th>
              <th class="align-center">Any Data</th>
              <th class="align-center">Sleep</th>
              <th class="align-center">Morning</th>
              <th class="align-center">Midday</th>
              <th class="align-center">Evening</th>
              <th class="align-center">Overall</th>
              <th class="align-right">Weight ({{ checkin_weight_unit }})</th>
              <th class="align-right">Productivity</th>
              <th>Open</th>
            </tr>
          </thead>
          <tbody>
            {% for row in history_rows %}
              <tr {% if row.is_today %}style="background: #f2f8f7;"{% endif %}>
                <td>
                  {{ row.record.day }}{% if row.is_today %} (today){% endif %}
                </td>
                <td class="align-center">{{ "yes" if row.has_data else "no" }}</td>
                <td class="align-center">{{ "done" if row.segments.sleep else "-" }}</td>
                <td class="align-center">{{ "done" if row.segments.morning else "-" }}</td>
                <td class="align-center">{{ "done" if row.segments.midday else "-" }}</td>
                <td class="align-center">{{ "done" if row.segments.evening else "-" }}</td>
                <td class="align-center">{{ "done" if row.segments.overall else "-" }}</td>
                <td class="align-right">
                  {% if row.record.morning_weight_kg is not none %}
                    {% if checkin_unit_system == "imperial" %}
                      {{ (row.record.morning_weight_kg * 2.2046226218) | round(1) }}
                    {% else %}
                      {{ row.record.morning_weight_kg | round(2) }}
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="align-right">{{ row.record.productivity if row.record.productivity is not none else "-" }}</td>
                <td>
                  <a href="{{ url_for('main.checkin_form', day=row.record.day.isoformat(), view='checkin') }}">Open</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No check-ins yet.</p>
    {% endif %}
  </div>

  <script>
    const defaultTab = "{{ checkin_default_tab or 'sleep' }}";
    const tabButtons = document.querySelectorAll(".checkin-tab-btn");
    const tabPanels = document.querySelectorAll(".checkin-tab-panel");

    function setTab(tabName) {
      tabButtons.forEach((btn) => {
        if (btn.dataset.tab === tabName) {
          btn.style.background = "#0f766e";
          btn.style.color = "#fff";
        } else {
          btn.style.background = "#fff";
          btn.style.color = "#17212b";
        }
      });
      tabPanels.forEach((panel) => {
        panel.style.display = panel.dataset.panel === tabName ? "" : "none";
      });
    }

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    setTab(defaultTab);
  </script>
  {% endif %}

  <script>
    function wireQuickFavoriteSelect(selectId, fieldMap, favoriteNameInputId) {
      const select = document.getElementById(selectId);
      if (!select) {
        return;
      }
      select.addEventListener("change", () => {
        const selectedOption = select.options[select.selectedIndex];
        Object.entries(fieldMap).forEach(([dataAttr, fieldId]) => {
          const field = document.getElementById(fieldId);
          if (!field) {
            return;
          }
          const value = selectedOption ? (selectedOption.getAttribute(dataAttr) || "") : "";
          field.value = value;
        });

        if (favoriteNameInputId) {
          const favoriteNameField = document.getElementById(favoriteNameInputId);
          if (favoriteNameField && !favoriteNameField.value && selectedOption && selectedOption.value) {
            favoriteNameField.value = selectedOption.textContent.trim();
          }
        }
      });
    }

    wireQuickFavoriteSelect(
      "meal_favorite_id",
      {
        "data-label": "meal_label",
        "data-description": "meal_description",
        "data-portion_notes": "meal_portion_notes",
        "data-calories": "meal_calories",
        "data-protein_g": "meal_protein_g",
        "data-carbs_g": "meal_carbs_g",
        "data-fat_g": "meal_fat_g"
      },
      "meal_favorite_name"
    );

    wireQuickFavoriteSelect(
      "drink_favorite_id",
      {
        "data-description": "drink_description",
        "data-portion_notes": "drink_portion_notes",
        "data-calories": "drink_calories",
        "data-sugar_g": "drink_sugar_g",
        "data-caffeine_mg": "drink_caffeine_mg"
      },
      "drink_favorite_name"
    );

    wireQuickFavoriteSelect(
      "sub_favorite_id",
      {
        "data-kind": "sub_kind",
        "data-amount": "sub_amount",
        "data-notes": "sub_notes"
      },
      "sub_favorite_name"
    );

    wireQuickFavoriteSelect(
      "act_favorite_id",
      {
        "data-activity_type": "activity_type",
        "data-duration_min": "duration_min",
        "data-intensity": "intensity",
        "data-notes": "act_notes"
      },
      "act_favorite_name"
    );

    wireQuickFavoriteSelect(
      "med_favorite_id",
      {
        "data-kind": "med_kind",
        "data-med_name": "med_name",
        "data-dose": "dose",
        "data-notes": "med_notes"
      },
      "med_favorite_name"
    );

    const mimAssistEndpoint = "{{ url_for('main.ai_day_manager_assist') }}";

    function sanitizePrompt(value) {
      return String(value || "").replace(/\s+/g, " ").trim();
    }

    function applySuggestedFields(fieldMap, suggestedFields) {
      if (!suggestedFields || typeof suggestedFields !== "object") {
        return;
      }
      Object.entries(fieldMap).forEach(([suggestedKey, fieldId]) => {
        if (!(suggestedKey in suggestedFields)) {
          return;
        }
        const field = document.getElementById(fieldId);
        if (!field) {
          return;
        }
        const value = suggestedFields[suggestedKey];
        if (field.type === "checkbox") {
          field.checked = Boolean(value);
          return;
        }
        if (value === null || value === undefined || value === "") {
          return;
        }
        field.value = String(value);
      });
    }

    function wireMimAssist(config) {
      const toggleButton = document.getElementById(config.toggleId);
      const panel = document.getElementById(config.panelId);
      const promptInput = document.getElementById(config.promptId);
      const runButton = document.getElementById(config.runId);
      const loadingRow = document.getElementById(config.loadingId);
      const statusEl = document.getElementById(config.statusId);
      const sourceInput = document.getElementById(config.sourceFieldId);
      if (!toggleButton || !panel || !promptInput || !runButton || !loadingRow || !statusEl || !sourceInput) {
        return;
      }

      let panelOpened = false;

      async function runAssist() {
        const seedText = sanitizePrompt(promptInput.value) || sanitizePrompt(sourceInput.value);
        if (!seedText) {
          statusEl.textContent = config.emptyPrompt || "Tell MIM what to log and include enough detail.";
          promptInput.focus();
          return;
        }

        loadingRow.style.display = "";
        runButton.disabled = true;
        statusEl.textContent = "";

        try {
          const response = await fetch(mimAssistEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ context: config.context, text: seedText })
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || "MIM assist failed.");
          }

          if (data.reply) {
            statusEl.textContent = data.reply;
          }
          applySuggestedFields(config.fieldMap, data.suggested_fields || {});

          if (data.follow_up_prompt && !sanitizePrompt(promptInput.value)) {
            promptInput.value = data.follow_up_prompt;
          }

          if (Array.isArray(data.unmatched_ingredients) && data.unmatched_ingredients.length > 0) {
            const unmatched = data.unmatched_ingredients.slice(0, 4).join(", ");
            statusEl.textContent = `${statusEl.textContent} Unmatched: ${unmatched}.`;
          }
        } catch (error) {
          statusEl.textContent = error.message || "MIM assist failed.";
        } finally {
          loadingRow.style.display = "none";
          runButton.disabled = false;
        }
      }

      toggleButton.addEventListener("click", () => {
        panelOpened = !panelOpened;
        panel.style.display = panelOpened ? "" : "none";
        if (!panelOpened) {
          return;
        }
        if (!sanitizePrompt(promptInput.value)) {
          promptInput.value = sanitizePrompt(sourceInput.value);
        }
        if (sanitizePrompt(sourceInput.value)) {
          runAssist();
        } else {
          statusEl.textContent = config.greetingPrompt || "Hi there, tell MIM what to log and I can start filling this form.";
          promptInput.focus();
        }
      });

      runButton.addEventListener("click", runAssist);
      promptInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          runAssist();
        }
      });
    }

    wireMimAssist({
      context: "meal",
      toggleId: "meal_mim_toggle",
      panelId: "meal_mim_panel",
      promptId: "meal_mim_prompt",
      runId: "meal_mim_run",
      loadingId: "meal_mim_loading",
      statusId: "meal_mim_status",
      sourceFieldId: "meal_description",
      fieldMap: {
        description: "meal_description",
        label: "meal_label",
        portion_notes: "meal_portion_notes",
        calories: "meal_calories",
        protein_g: "meal_protein_g",
        carbs_g: "meal_carbs_g",
        fat_g: "meal_fat_g"
      },
      emptyPrompt: "Tell MIM what you ate and include ingredients/amounts.",
      greetingPrompt: "Hi there, tell MIM what was in this meal and I can start filling it."
    });

    wireMimAssist({
      context: "drink",
      toggleId: "drink_mim_toggle",
      panelId: "drink_mim_panel",
      promptId: "drink_mim_prompt",
      runId: "drink_mim_run",
      loadingId: "drink_mim_loading",
      statusId: "drink_mim_status",
      sourceFieldId: "drink_description",
      fieldMap: {
        description: "drink_description",
        portion_notes: "drink_portion_notes",
        calories: "drink_calories",
        sugar_g: "drink_sugar_g",
        caffeine_mg: "drink_caffeine_mg"
      },
      emptyPrompt: "Tell MIM what drink you had and rough amounts.",
      greetingPrompt: "Hi there, tell MIM what was in this drink and I can start filling it."
    });

    wireMimAssist({
      context: "substance",
      toggleId: "sub_mim_toggle",
      panelId: "sub_mim_panel",
      promptId: "sub_mim_prompt",
      runId: "sub_mim_run",
      loadingId: "sub_mim_loading",
      statusId: "sub_mim_status",
      sourceFieldId: "sub_amount",
      fieldMap: {
        kind: "sub_kind",
        amount: "sub_amount",
        notes: "sub_notes"
      },
      emptyPrompt: "Tell MIM what substance you took and how much.",
      greetingPrompt: "Hi there, tell MIM what you took and I can draft this entry."
    });

    wireMimAssist({
      context: "activity",
      toggleId: "act_mim_toggle",
      panelId: "act_mim_panel",
      promptId: "act_mim_prompt",
      runId: "act_mim_run",
      loadingId: "act_mim_loading",
      statusId: "act_mim_status",
      sourceFieldId: "activity_type",
      fieldMap: {
        activity_type: "activity_type",
        duration_min: "duration_min",
        intensity: "intensity",
        notes: "act_notes"
      },
      emptyPrompt: "Tell MIM the activity, duration, and intensity if known.",
      greetingPrompt: "Hi there, tell MIM your workout details and I can prefill this form."
    });

    wireMimAssist({
      context: "medications",
      toggleId: "med_mim_toggle",
      panelId: "med_mim_panel",
      promptId: "med_mim_prompt",
      runId: "med_mim_run",
      loadingId: "med_mim_loading",
      statusId: "med_mim_status",
      sourceFieldId: "med_name",
      fieldMap: {
        kind: "med_kind",
        med_name: "med_name",
        dose: "dose",
        notes: "med_notes"
      },
      emptyPrompt: "Tell MIM the medication/supplement and dose.",
      greetingPrompt: "Hi there, tell MIM what you took and I can prefill meds/supps."
    });
  </script>
  </div>
{% endblock %}
