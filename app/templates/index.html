{% extends "base.html" %}
{% block content %}
  <style>
    .landing-wrap {
      max-width: 520px;
      margin: 0 auto;
    }
    .landing-title {
      font-size: clamp(2rem, 8vw, 2.5rem);
      line-height: 1.05;
      margin-bottom: 8px;
      letter-spacing: 0.2px;
    }
    .landing-sub {
      margin-top: 0;
      color: var(--muted);
      font-size: 1rem;
    }
    .landing-image-box {
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: #eef3f8;
      margin: 12px 0 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 260px;
    }
    .landing-image-box img {
      width: 100%;
      max-width: 380px;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      display: block;
      opacity: 1;
      transition: opacity 420ms ease;
    }
    .landing-image-dots {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    .landing-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      border: 1px solid #9db4cb;
      background: #d9e5f0;
    }
    .landing-dot.active {
      background: #0f766e;
      border-color: #0f766e;
    }
    .landing-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 6px;
    }
    .landing-btn {
      text-decoration: none;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 11px 12px;
      background: #fff;
      color: var(--text);
      font-weight: 700;
      text-align: center;
      display: block;
    }
    .landing-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .landing-links {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      font-size: 0.95rem;
    }
    .landing-links a {
      color: var(--muted);
    }
    .home-quick-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .home-quick-link {
      text-decoration: none;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 12px;
      background: #fff;
      color: var(--text);
      font-weight: 600;
    }
    .goal-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 0.85rem;
      color: var(--muted);
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e7edf4;
      overflow: hidden;
      margin: 6px 0 8px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0f766e, #14b8a6);
      border-radius: inherit;
    }
    .goal-note-list {
      margin: 0;
      padding-left: 20px;
    }
    .goal-note-list li + li {
      margin-top: 4px;
    }
    .goal-action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .inline-form {
      margin: 0;
    }
    .small-btn {
      padding: 8px 11px;
      font-size: 0.92rem;
    }
  </style>

  {% if is_authenticated %}
    <div class="card">
      <h1>Coach MIM</h1>
      <p>{{ public_content.home_intro }}</p>
      <p class="muted">Today is {{ local_today.strftime("%A, %B %d, %Y") }}. Day one is always now.</p>
    </div>

    <div class="card">
      <h2>Today At A Glance</h2>
      <div class="grid">
        <div>
          <div class="muted">Check-In Days Logged</div>
          <div class="metric">{{ checkin_count }}</div>
        </div>
        <div>
          <div class="muted">Meals Logged</div>
          <div class="metric">{{ meal_count }}</div>
        </div>
        <div>
          <div class="muted">Substance Entries</div>
          <div class="metric">{{ substance_count }}</div>
        </div>
        <div>
          <div class="muted">Active Goals</div>
          <div class="metric">{{ goals.active_count }}</div>
        </div>
      </div>
      <div class="goal-action-row">
        <a class="home-quick-link" href="{{ url_for('main.checkin_form') }}">Open Daily Check-In</a>
        <a class="home-quick-link" href="{{ url_for('main.goals_page') }}">Open My Goals</a>
      </div>
    </div>

    {% if profile_nudge %}
      <div class="card">
        <h2>MIM Profile Prompt</h2>
        <p>
          {{ profile_nudge.prompt }}
        </p>
        <p class="muted">
          {{ profile_nudge.remaining_count }} required profile field{{ "" if profile_nudge.remaining_count == 1 else "s" }} remaining.
        </p>
        <div class="goal-action-row">
          <a class="home-quick-link" href="{{ url_for('main.profile') }}">Open Profile</a>
          <form class="inline-form" method="post" action="{{ url_for('main.profile_nudge_settings') }}">
            <input type="hidden" name="action" value="later" />
            <input type="hidden" name="next" value="{{ url_for('main.index') }}" />
            <button class="small-btn" type="submit">Ask Tomorrow</button>
          </form>
          <form class="inline-form" method="post" action="{{ url_for('main.profile_nudge_settings') }}">
            <input type="hidden" name="action" value="stop" />
            <input type="hidden" name="next" value="{{ url_for('main.index') }}" />
            <button class="small-btn" type="submit">Do Not Ask Again</button>
          </form>
        </div>
      </div>
    {% elif missing_required %}
      <div class="card">
        <h2>Profile Baseline</h2>
        <p class="muted">
          Core profile fields still missing:
          {{ missing_required | join(", ") }}.
        </p>
        <div class="goal-action-row">
          <a class="home-quick-link" href="{{ url_for('main.profile') }}">Complete Profile</a>
          <form class="inline-form" method="post" action="{{ url_for('main.profile_nudge_settings') }}">
            <input type="hidden" name="action" value="resume" />
            <input type="hidden" name="next" value="{{ url_for('main.index') }}" />
            <button class="small-btn" type="submit">Re-Enable Prompts</button>
          </form>
        </div>
      </div>
    {% endif %}

    <div class="card">
      <h2>MIM Goal Pulse</h2>
      {% if goals.top_goal %}
        <p style="margin-bottom: 6px;">
          <strong>{{ goals.top_goal.goal.title }}</strong>
          <span class="goal-pill">{{ goals.top_goal.goal_type_label }}</span>
          <span class="goal-pill">{{ goals.top_goal.goal.status|capitalize }}</span>
        </p>
        <div class="progress-track">
          <div class="progress-fill" style="width: {{ goals.top_goal.progress_pct }}%;"></div>
        </div>
        <p class="muted" style="margin: 0 0 10px;">{{ goals.top_goal.metric_line }}</p>
        <p class="muted" style="margin: 0 0 10px;">
          Consistency {{ goals.top_goal.consistency_pct }}% | Streak {{ goals.top_goal.streak }} day{{ "" if goals.top_goal.streak == 1 else "s" }}
        </p>
      {% else %}
        <p class="muted">No active goals yet. Start one and MIM will coach daily execution.</p>
      {% endif %}
      <ul class="goal-note-list">
        {% for note in goals.notes %}
          <li>{{ note }}</li>
        {% endfor %}
      </ul>
      <div class="goal-action-row">
        <a class="home-quick-link" href="{{ url_for('main.goals_page') }}">Go To My Goals</a>
      </div>
    </div>

    <div class="card">
      <h2>Weekly Snapshot</h2>
      <p class="muted">
        {{ weekly.week_start.strftime("%b %d") }} - {{ weekly.week_end.strftime("%b %d, %Y") }}
      </p>
      <div class="grid">
        <div>
          <div class="muted">Workout Time This Week</div>
          <div class="metric">{{ weekly.workout_minutes }} min</div>
          <div class="muted">{{ weekly.workout_sessions }} session{{ "" if weekly.workout_sessions == 1 else "s" }}</div>
        </div>
        <div>
          <div class="muted">Avg Calories / Logged Day</div>
          <div class="metric">{{ weekly.avg_calories_per_logged_day if weekly.avg_calories_per_logged_day is not none else "n/a" }}</div>
          <div class="muted">{{ weekly.total_calories_week }} total this week</div>
        </div>
        <div>
          <div class="muted">Check-In Coverage</div>
          <div class="metric">{{ weekly.coverage_pct }}%</div>
          <div class="muted">{{ weekly.checkins_logged_week }} of 7 days</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Average Metrics (7d)</h2>
      <div class="grid">
        <div>
          <div class="muted">Sleep Hours</div>
          <div class="metric">{{ weekly.avg_sleep if weekly.avg_sleep is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Energy (1-10)</div>
          <div class="metric">{{ weekly.avg_energy if weekly.avg_energy is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Focus (1-10)</div>
          <div class="metric">{{ weekly.avg_focus if weekly.avg_focus is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Mood (1-10)</div>
          <div class="metric">{{ weekly.avg_mood if weekly.avg_mood is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Stress (1-10)</div>
          <div class="metric">{{ weekly.avg_stress if weekly.avg_stress is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Productivity (1-10)</div>
          <div class="metric">{{ weekly.avg_productivity if weekly.avg_productivity is not none else "n/a" }}</div>
        </div>
        <div>
          <div class="muted">Anxiety (1-10)</div>
          <div class="metric">{{ weekly.avg_anxiety if weekly.avg_anxiety is not none else "n/a" }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>MIM Weekly Summary</h2>
      <p class="muted">Primary goal: {{ weekly.primary_goal }}</p>
      <ul style="margin-top: 0;">
        {% for note in weekly.mim_notes %}
          <li>{{ note }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card">
      <h2>More Views</h2>
      <div class="home-quick-links">
        <a class="home-quick-link" href="{{ url_for('main.timeline') }}">Timeline</a>
        <a class="home-quick-link" href="{{ url_for('main.insights') }}">Weekly Insights</a>
        <a class="home-quick-link" href="{{ url_for('main.goals_page') }}">My Goals</a>
      </div>
    </div>
  {% else %}
    <div class="card landing-wrap">
      <h2 class="landing-title">Coach MIM</h2>
      <p class="landing-sub">{{ public_content.home_intro }}</p>
      <div class="landing-image-box">
        <img id="landing-hero-image" src="{{ url_for('static', filename='mim workout 1.png') }}" alt="Coach MIM" />
      </div>
      <div class="landing-image-dots" aria-hidden="true">
        <span class="landing-dot active" data-dot-index="0"></span>
        <span class="landing-dot" data-dot-index="1"></span>
        <span class="landing-dot" data-dot-index="2"></span>
        <span class="landing-dot" data-dot-index="3"></span>
        <span class="landing-dot" data-dot-index="4"></span>
      </div>
      <div class="landing-actions">
        <a class="landing-btn primary" href="{{ url_for('main.login') }}">Login</a>
        <a class="landing-btn" href="{{ url_for('main.register') }}">Sign Up</a>
        <a class="landing-btn" href="{{ url_for('main.lost_password') }}">Lost Password</a>
      </div>
      <div class="landing-links">
        <a href="{{ url_for('main.about_page') }}">About</a>
        <a href="{{ url_for('main.privacy_page') }}">Privacy</a>
        <a href="{{ url_for('main.terms_page') }}">Terms</a>
      </div>
    </div>
  {% endif %}

  {% if is_authenticated %}
    <div class="card">
      <h2>Support & Policies</h2>
      <p class="muted">
        Contact for help:
        <a href="mailto:{{ public_content.contact_email }}">{{ public_content.contact_email }}</a>
      </p>
      <div class="home-quick-links">
        <a class="home-quick-link" href="{{ url_for('main.about_page') }}">About</a>
        <a class="home-quick-link" href="{{ url_for('main.privacy_page') }}">Privacy Policy</a>
        <a class="home-quick-link" href="{{ url_for('main.terms_page') }}">Terms</a>
      </div>
    </div>
  {% endif %}

  {% if not is_authenticated %}
    <script>
      (function () {
        const hero = document.getElementById("landing-hero-image");
        if (!hero) return;

        const images = [
          "{{ url_for('static', filename='mim workout 1.png') }}",
          "{{ url_for('static', filename='mim workout 2.png') }}",
          "{{ url_for('static', filename='mim workout 3.png') }}",
          "{{ url_for('static', filename='mim workout 4.png') }}",
          "{{ url_for('static', filename='mim workout 5.png') }}"
        ];
        const dots = Array.from(document.querySelectorAll(".landing-dot"));

        let index = 0;
        const preload = (i) => {
          const img = new Image();
          img.src = images[i];
        };
        const setDot = (activeIndex) => {
          dots.forEach((dot, dotIndex) => {
            if (dotIndex === activeIndex) {
              dot.classList.add("active");
            } else {
              dot.classList.remove("active");
            }
          });
        };

        preload(1);
        setInterval(() => {
          index = (index + 1) % images.length;
          hero.style.opacity = "0";
          setTimeout(() => {
            hero.src = images[index];
            hero.style.opacity = "1";
            setDot(index);
            preload((index + 1) % images.length);
          }, 220);
        }, 7000);
      })();
    </script>
  {% endif %}
{% endblock %}
